{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{443:function(a,t,e){a.exports=e.p+\"assets/img/2019-02-2016.06.49.32943348.png\"},444:function(a,t,e){a.exports=e.p+\"assets/img/2019-02-2016.09.30.d2e272ac.png\"},526:function(a,t,e){\"use strict\";e.r(t);var s=e(25),r=Object(s.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":a.$parent.slotKey}},[s(\"h1\",{attrs:{id:\"no-reboot로-생성한-ec2-ami-내-파일크기가-0byte다\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#no-reboot로-생성한-ec2-ami-내-파일크기가-0byte다\"}},[a._v(\"#\")]),a._v(\" No Reboot로 생성한 EC2 AMI 내 파일크기가 0byte다\")]),a._v(\" \"),s(\"p\",[s(\"a\",{attrs:{href:\"https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a._v(\"Amazon EBS 지원 Linux AMI 생성 - Amazon Elastic Compute Cloud\"),s(\"OutboundLink\")],1)]),a._v(\" \"),s(\"blockquote\",[s(\"p\",[s(\"strong\",[s(\"em\",[a._v(\"주의\")])]),s(\"br\"),a._v(\" \"),s(\"strong\",[a._v(\"재부팅 안 함\")]),a._v(\"을 선택한 경우 생성된 이미지의 파일 시스템 무결성을 보장할 수 없습니다.\")])]),a._v(\" \"),s(\"h1\",{attrs:{id:\"발생한-현상\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#발생한-현상\"}},[a._v(\"#\")]),a._v(\" 발생한 현상\")]),a._v(\" \"),s(\"p\",[s(\"strong\",[a._v(\"No Reboot\")]),a._v(\"로 AMI를 만들었더니 해당 AMI로 띄운 EC2 내 파일이 0byte다.\")]),a._v(\" \"),s(\"h1\",{attrs:{id:\"환경\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#환경\"}},[a._v(\"#\")]),a._v(\" 환경\")]),a._v(\" \"),s(\"ul\",[s(\"li\",[a._v(\"Linux (Amazon Linux 추정)\")])]),a._v(\" \"),s(\"h1\",{attrs:{id:\"amazon-linux-파일-시스템의-이해\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#amazon-linux-파일-시스템의-이해\"}},[a._v(\"#\")]),a._v(\" Amazon Linux 파일 시스템의 이해\")]),a._v(\" \"),s(\"ul\",[s(\"li\",[s(\"p\",[a._v(\"Amazon Linux의 파일 시스템 : \"),s(\"strong\",[a._v(\"ext4\")]),a._v(\" (→Amazon Linux2의 경우 \"),s(\"strong\",[a._v(\"xfs\")]),a._v(\"로 확인됨**)**\")]),a._v(\" \"),s(\"div\",{staticClass:\"language-bash extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[s(\"code\",[a._v(\"$ \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"df\")]),a._v(\" -T /\\n\")])])]),s(\"ul\",[s(\"li\",[s(\"strong\",[a._v(\"지연할당\")]),a._v(\" (Delayed allocation) 기능 : 데이터를 디스크에 커밋할 준비가 될 때 데이터를 쓸 실제 블록을 할당. (기록된 후 30초 이상 경과한 캐시 페이지는 5초 이내에 실제 장치에 기록. 내보낼 페이지가 많으면 더 늦어질 경우도 있음.)\\n\"),s(\"ul\",[s(\"li\",[a._v(\"(장) 캐쉬에 데이터를 누적하여 블록 할당을 지연시키는 것으로, 파일 시스템이 해당 블록을 할당하는 것보다 성능이 향상 됨.\")]),a._v(\" \"),s(\"li\",[a._v(\"(단) 데이터 손실 가능성이 높음.\")]),a._v(\" \"),s(\"li\",[s(\"em\",[a._v(\"데이터가 디스크에 즉시 기록되도록 보장하는 유일한 방법은 \"),s(\"code\",[a._v(\"fsync()\")]),a._v(\" 를 알맞게 호출하는 것\")])])])])])])]),a._v(\" \"),s(\"h2\",{attrs:{id:\"zero-length-problem\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#zero-length-problem\"}},[a._v(\"#\")]),a._v(\" Zero-length problem\")]),a._v(\" \"),s(\"ul\",[s(\"li\",[s(\"p\",[a._v(\"특정 파일 조작에 의해 파일이 치환 된 후 시스템 강제 종료 등으로 인해 sync가 완료되지 않은 상태로 종료된 경우 파일이 0byte 가 되어버리는 것\")])]),a._v(\" \"),s(\"li\",[s(\"p\",[s(\"code\",[a._v(\"fsync()\")]),a._v(\" 를 사용하지 않고 기존 파일을 바꾸는 경우\")]),a._v(\" \"),s(\"ul\",[s(\"li\",[a._v(\"보통 1. 파일생성 → 2. 이름 변경 처리 → 3. 지연 할당 의 순서대로 처리되는데, 2에서 전원 차단이 발생하면 더이상 데이터가 기록이 되지 않기 때문에 0바이트가 되는 것\")])])]),a._v(\" \"),s(\"li\",[s(\"p\",[a._v(\"마운트 시 대책 : \"),s(\"code\",[a._v(\"noauto_da_alloc\")]),a._v(\" 옵션 추가\")]),a._v(\" \"),s(\"div\",{staticClass:\"language-bash extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[s(\"code\",[a._v(\"$ \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"sudo\")]),a._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"mount\")]),a._v(\" 장치 대상 -t ext4 -o noauto_da_alloc\\n\")])])]),s(\"ul\",[s(\"li\",[a._v(\"위와 같이 옵션을 추가 하면 1. 파일 생성 → 2. 데이터 쓰기 → 3. 이름 변경 처리 의 순서로 변경됨\")]),a._v(\" \"),s(\"li\",[a._v(\"단, 파일 처리 시퀀스의 성능이 저하 됨.\\n\"),s(\"code\",[a._v(\"fsync\")]),a._v(\" 이 자동실행 되지 않기 때문에 되려 zero-length problem을 야기 시킬 수 있음.\")])])])]),a._v(\" \"),s(\"h2\",{attrs:{id:\"실제-지연할당-확인\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#실제-지연할당-확인\"}},[a._v(\"#\")]),a._v(\" 실제 지연할당 확인\")]),a._v(\" \"),s(\"div\",{staticClass:\"language-bash extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[s(\"code\",[a._v(\"$ \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"watch\")]),a._v(\" -n \"),s(\"span\",{pre:!0,attrs:{class:\"token number\"}},[a._v(\"1\")]),a._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"sudo\")]),a._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"grep\")]),a._v(\" -E \"),s(\"span\",{pre:!0,attrs:{class:\"token string\"}},[a._v('\"Dirty\\\\|Writeback\"')]),a._v(\" /proc/meminfo\\n\")])])]),s(\"p\",[s(\"img\",{attrs:{src:e(443),alt:\"image1\"}})]),a._v(\" \"),s(\"ul\",[s(\"li\",[a._v(\"위 명령어를 통해 내보내기를 하고 있지 않은 Dirty 페이지의 사이즈를 확인(Swap 디바이스에 내보내기 하는 것 포함)\")])]),a._v(\" \"),s(\"div\",{staticClass:\"language-bash extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[s(\"code\",[a._v(\"$ \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"vmstat\")]),a._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token number\"}},[a._v(\"1\")]),a._v(\"\\n\")])])]),s(\"p\",[s(\"img\",{attrs:{src:e(444),alt:\"image2\"}})]),a._v(\" \"),s(\"ul\",[s(\"li\",[s(\"code\",[a._v(\"bo\")]),a._v(\" (블록 디바이스로의 내보내기량)의 값에 주목\")])]),a._v(\" \"),s(\"h1\",{attrs:{id:\"정리\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#정리\"}},[a._v(\"#\")]),a._v(\" 정리\")]),a._v(\" \"),s(\"ul\",[s(\"li\",[a._v(\"ext4를 포함한 파일시스템에서는 고속화 등의 이유로 쓰기 처리를 할 때 디스크에 내보내기를 하기까지 지연 시간이 발생할 가능성이 있다.\")]),a._v(\" \"),s(\"li\",[s(\"strong\",[a._v(\"따라서 내보내기 처리 전에 스냅샷을 하면, 파일 시스템의 무결성이 보장되지 않는다.\")])])]),a._v(\" \"),s(\"h1\",{attrs:{id:\"대책\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#대책\"}},[a._v(\"#\")]),a._v(\" 대책?\")]),a._v(\" \"),s(\"ul\",[s(\"li\",[s(\"p\",[a._v(\"디스크에 내보내기를 할 시간을 충분히 주고 나서, No Reboot 옵션으로 AMI를 뜬다.\")])]),a._v(\" \"),s(\"li\",[s(\"p\",[a._v(\"XFS의 경우 \"),s(\"code\",[a._v(\"xfs_freeze\")]),a._v(\" 를 이용하여 쓰기 동작을 일시 정지 할 수 있다.\")]),a._v(\" \"),s(\"ul\",[s(\"li\",[a._v(\"xfs_freeze 유틸리티를 이용하면 ext3、 ext4、 GFS2、 XFS、 BTRFS 등의 파일시스템에서도 쓸 수 있다고 하는데... 확인 필요\")])]),a._v(\" \"),s(\"p\",[s(\"a\",{attrs:{href:\"https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/storage_administration_guide/xfsfreeze\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a._v(\"Red Hat Customer Portal\"),s(\"OutboundLink\")],1)]),a._v(\" \"),s(\"ul\",[s(\"li\",[s(\"code\",[a._v(\"xfsprogs\")]),a._v(\" 패키지를 통해 사용 가능. (x86_64 에서만 가능)\")])]),a._v(\" \"),s(\"div\",{staticClass:\"language-bash extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[s(\"code\",[a._v(\"$ xfs_freeze -f /mount/point\\n\")])])]),s(\"ul\",[s(\"li\",[a._v(\"위의 명령어(\"),s(\"code\",[a._v(\"xfs_freeze -f\")]),a._v(\")로 XFS 파일 시스템을 일시 정지 가능\")])]),a._v(\" \"),s(\"div\",{staticClass:\"language-bash extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[s(\"code\",[a._v(\"$ xfs_freeze -u /mount/point\\n\")])])]),s(\"ul\",[s(\"li\",[a._v(\"위의 명령어(\"),s(\"code\",[a._v(\"xfs_freeze -u\")]),a._v(\")로 일시 정지 상태 해제\")])]),a._v(\" \"),s(\"div\",{staticClass:\"language-bash extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[s(\"code\",[a._v(\"$ \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[a._v(\"man\")]),a._v(\" xfs_freeze\\n\")])])]),s(\"ul\",[s(\"li\",[a._v(\"위의 명령어로 \"),s(\"code\",[a._v(\"xfs_freeze\")]),a._v(\" 의 처리 세부 사항 확인 가능\")])])]),a._v(\" \"),s(\"li\",[s(\"p\",[s(\"strong\",[a._v(\"No Reboot를 사용하지 않는다.\")])]),a._v(\" \"),s(\"ul\",[s(\"li\",[a._v(\"Reboot 하여 확실히 디스크에 내보내기 할 수 있도록 설정한다.\")])])])]),a._v(\" \"),s(\"h1\",{attrs:{id:\"참고자료\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#참고자료\"}},[a._v(\"#\")]),a._v(\" 참고자료\")]),a._v(\" \"),s(\"p\",[s(\"a\",{attrs:{href:\"https://www.ibm.com/developerworks/jp/linux/library/l-anatomy-ext4/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a._v(\"ext4 の徹底調査\"),s(\"OutboundLink\")],1)]),a._v(\" \"),s(\"p\",[s(\"a\",{attrs:{href:\"https://qiita.com/mechamogera/items/60a23cf5a52f8ebd8417\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a._v(\"No Reboot で AMI を作成したらファイルが消えたりした - Qiita\"),s(\"OutboundLink\")],1)]),a._v(\" \"),s(\"p\",[a._v(\"[가상 메모리 통계 표시(vmstat ) - 시스템 관리 설명서: 고급 관리](\")])])}),[],!1,null,null,null);t.default=r.exports}}]);","extractedComments":[]}